# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 504 –∏ —Å—Ç–∞—Ç—É—Å–∞ AI

## –ü—Ä–æ–±–ª–µ–º—ã

### 1. –û—à–∏–±–∫–∞ 504 –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ dashboard
–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ dashboard –≤–æ –≤—Ä–µ–º—è –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–∞:
```
Failed to load resource: the server responded with a status of 504 ()
```

### 2. AI Status –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ì–æ—Ç–æ–≤"
–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö (FAQ, KB Pages, Scripts, Training) —Å—Ç–∞—Ç—É—Å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–¢—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ"

## –ü—Ä–∏—á–∏–Ω—ã

1. **–§—É–Ω–∫—Ü–∏—è `get_ai_status()` –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö ‚Üí –≤—ã–∑—ã–≤–∞–ª–∞ timeout 504
2. **–§—É–Ω–∫—Ü–∏—è —á–∏—Ç–∞–ª–∞ –Ω–µ —Ç—É —Ç–∞–±–ª–∏—Ü—É** ‚Üí –ø—Ä–æ–≤–µ—Ä—è–ª–∞ `ai_chunks` –≤–º–µ—Å—Ç–æ –ø–æ–ª—è `ai_status` –≤ —Ç–∞–±–ª–∏—Ü–µ `tenants`

## –†–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É tenants (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)

–û—Ç–∫—Ä–æ–π—Ç–µ **Supabase SQL Editor** –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `CREATE_TENANTS_TABLE.sql`:

```sql
-- –°–º. —Ñ–∞–π–ª CREATE_TENANTS_TABLE.sql
```

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞:
- ‚úÖ –°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—É `tenants` —Å –ø–æ–ª—è–º–∏ `ai_status` –∏ `ai_last_indexed_at`
- ‚úÖ –°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—É `tenant_members` –¥–ª—è —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, SQL –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –∏ –∏–Ω–¥–µ–∫—Å—ã.

### –®–∞–≥ 2: –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é get_ai_status()

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ **Supabase SQL Editor** —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `AI_STATUS_FUNCTION.sql`:

```sql
-- –°–º. —Ñ–∞–π–ª AI_STATUS_FUNCTION.sql
```

–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è:
- ‚úÖ **–ß–∏—Ç–∞–µ—Ç –ø–æ–ª–µ `ai_status` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `tenants`** —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç tenant_id –¥–ª—è –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏
- ‚úÖ Fallback –Ω–∞ –∞–Ω–∞–ª–∏–∑ `ai_chunks`, –µ—Å–ª–∏ `ai_status` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å: `empty`, `indexing`, `ready`, `needs_reindex`
- ‚úÖ –ò–º–µ–µ—Ç `statement_timeout = 30s` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–æ–ª–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ —Å fallback —Å—Ç–∞—Ç—É—Å–æ–º

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ (—É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

–í [dashboard-content.tsx](app/app/dashboard-content.tsx) –¥–æ–±–∞–≤–ª–µ–Ω—ã:

**Retry –º–µ—Ö–∞–Ω–∏–∑–º:**
- –î–æ 2 –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ 504 –∏–ª–∏ timeout
- –ó–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏

**–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π timeout:**
- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π timeout: 60 —Å–µ–∫—É–Ω–¥
- –°–µ—Ä–≤–µ—Ä–Ω—ã–π timeout (–≤ SQL —Ñ—É–Ω–∫—Ü–∏–∏): 30 —Å–µ–∫—É–Ω–¥

**–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- Graceful fallback –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ "needs_reindex"

–ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è/–∏–∑–º–µ–Ω—è—é—Ç—Å—è/—É–¥–∞–ª—è—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ, –∫–æ–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç `tenants.ai_status`:

```typescript
// –ü—Ä–∏–º–µ—Ä –∏–∑ lib/actions/faq-items.ts
await supabase
  .from('tenants')
  .update({ ai_status: 'needs_reindex' })
  .eq('id', tenantRow.id)
```

–≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏:
- –°–æ–∑–¥–∞–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ FAQ items
- –°–æ–∑–¥–∞–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ KB Pages
- –°–æ–∑–¥–∞–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏ Training Docs
- –°–æ–∑–¥–∞–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ Scripts –∏ Turns

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ "ready"

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ ([lib/actions/ai-search.ts](lib/actions/ai-search.ts#L446)):

```typescript
await supabase
  .from('tenants')
  .update({
    ai_status: 'ready',
    ai_last_indexed_at: new Date().toISOString(),
  })
  .eq('id', tenantRow.id)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

Dashboard –≤—ã–∑—ã–≤–∞–µ—Ç `get_ai_status()`, –∫–æ—Ç–æ—Ä–∞—è:
1. –ß–∏—Ç–∞–µ—Ç `tenants.ai_status` –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ tenant_id
2. –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç `ai_chunks`
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —á–∞–Ω–∫–æ–≤

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:

1. **–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É dashboard**
2. **–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π FAQ item –∏–ª–∏ KB Page**
3. **AI Status –¥–æ–ª–∂–µ–Ω –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –Ω–∞ "–¢—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ"** (üü° –∂—ë–ª—Ç—ã–π)
4. **–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û–±—É—á–∏—Ç—å –ò–ò"**
5. **–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏—Ç—Å—è –Ω–∞ "–ò–ò –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"** (üü¢ –∑–µ–ª—ë–Ω—ã–π)
6. **–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ 504**

## –°—Ç–∞—Ç—É—Å—ã AI

| –°—Ç–∞—Ç—É—Å | –ó–Ω–∞—á–µ–Ω–∏–µ | –¶–≤–µ—Ç | –ö–æ–≥–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è |
|--------|----------|------|------------------|
| `empty` | –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö | –°–µ—Ä—ã–π | –ù–µ—Ç —á–∞–Ω–∫–æ–≤ –≤ ai_chunks |
| `needs_reindex` | –¢—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ | –ñ—ë–ª—Ç—ã–π | –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ |
| `indexing` | –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è... | –°–∏–Ω–∏–π | –í–æ –≤—Ä–µ–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ |
| `ready` | –ò–ò –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ | –ó–µ–ª—ë–Ω—ã–π | –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ |

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤—Å—ë –µ—â—ë –≤–æ–∑–Ω–∏–∫–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ tenants —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
   ```sql
   SELECT * FROM tenants LIMIT 1;
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é current_tenant_id():**
   ```sql
   SELECT public.current_tenant_id();
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ ai_status –≤—Ä—É—á–Ω—É—é:**
   ```sql
   SELECT id, ai_status, ai_last_indexed_at 
   FROM tenants 
   WHERE id = public.current_tenant_id();
   ```

4. **–ï—Å–ª–∏ ai_status NULL, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:**
   ```sql
   UPDATE tenants 
   SET ai_status = 'empty' 
   WHERE id = public.current_tenant_id();
   ```
