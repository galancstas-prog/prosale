# Исправление ошибки 504 для AI Status

## Проблема
При загрузке dashboard во время индексирования появляется ошибка:
```
Failed to load resource: the server responded with a status of 504 ()
```

## Причина
Функция `get_ai_status()` не существовала в базе данных, что вызывало timeout при попытке её вызова.

## Решение

### 1. Создайте функцию в Supabase

Откройте **Supabase SQL Editor** и выполните содержимое файла `AI_STATUS_FUNCTION.sql`:

```sql
-- См. файл AI_STATUS_FUNCTION.sql
```

Эта функция:
- ✅ Подсчитывает количество чанков в таблице `ai_chunks`
- ✅ Проверяет наличие чанков без embeddings (статус 'indexing')
- ✅ Возвращает корректный статус: `empty`, `indexing`, `ready`, `needs_reindex`
- ✅ Имеет `statement_timeout = 30s` для предотвращения долгих запросов
- ✅ Обрабатывает ошибки и возвращает fallback статус

### 2. Улучшения в коде

В [dashboard-content.tsx](app/app/dashboard-content.tsx) добавлены:

**Retry механизм:**
- До 2 попыток повторного запроса при ошибке 504 или timeout
- Задержка 2 секунды между попытками

**Увеличенный timeout:**
- Клиентский timeout увеличен до 60 секунд
- Серверный timeout (в SQL функции) = 30 секунд

**Улучшенная обработка ошибок:**
- Детальное логирование ошибок
- Graceful fallback при неудаче

## Тестирование

После применения изменений:
1. Перезагрузите страницу dashboard
2. AI Status должен загружаться без ошибок 504
3. В консоли браузера не должно быть ошибок

## Дополнительные улучшения

Если проблема всё ещё возникает:
1. Проверьте индексы на таблице `ai_chunks` (см. `SETUP_AI_DATABASE.sql`)
2. Убедитесь, что у пользователя есть права на выполнение функции
3. Проверьте Supabase Dashboard > Settings > API для лимитов timeout
