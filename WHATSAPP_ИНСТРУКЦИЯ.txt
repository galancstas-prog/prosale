═══════════════════════════════════════════════════════════════════════
                    WHATSAPP ИНТЕГРАЦИЯ — ИНСТРУКЦИЯ
                            ProSale 2026
═══════════════════════════════════════════════════════════════════════

📋 СОДЕРЖАНИЕ:
1. Обзор архитектуры
2. Применение миграции базы данных
3. Настройка WhatsApp Bridge Server
4. Деплой на AWS/Oracle Cloud
5. Подключение к ProSale
6. Устранение неполадок

═══════════════════════════════════════════════════════════════════════

1. ОБЗОР АРХИТЕКТУРЫ

┌─────────────────────────────────────────────────────────────────────┐
│                         АРХИТЕКТУРА                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   [WhatsApp]      [WhatsApp Bridge]        [ProSale App]           │
│       │                  │                      │                   │
│       │   Baileys        │    REST API          │                   │
│       ├─────────────────►│◄────────────────────►│                   │
│       │                  │                      │                   │
│       │   WebSocket      │    Supabase DB       │                   │
│       │                  │◄────────────────────►│                   │
│       │                  │                      │                   │
│   [Телефон]         [VPS сервер]          [Netlify/Vercel]         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

Компоненты:
• WhatsApp Bridge — Node.js сервер с Baileys (запускается на VPS)
• ProSale App — Next.js приложение (уже задеплоено на Netlify)
• Supabase — база данных и real-time subscriptions

═══════════════════════════════════════════════════════════════════════

2. ПРИМЕНЕНИЕ МИГРАЦИИ БАЗЫ ДАННЫХ

Шаг 1: Откройте Supabase Dashboard → SQL Editor

Шаг 2: Скопируйте содержимое файла: WHATSAPP_SETUP.sql

Шаг 3: Выполните SQL

Шаг 4: Проверьте, что созданы таблицы:
   • whatsapp_sessions
   • whatsapp_chats
   • whatsapp_messages
   • whatsapp_tags
   • whatsapp_quick_replies
   • whatsapp_chat_notes

═══════════════════════════════════════════════════════════════════════

3. НАСТРОЙКА WHATSAPP BRIDGE SERVER

Локальный запуск (для тестирования):

  cd whatsapp-bridge
  npm install
  
  # Создайте .env файл:
  echo "NEXT_PUBLIC_SUPABASE_URL=your_supabase_url" > .env
  echo "SUPABASE_SERVICE_ROLE_KEY=your_service_role_key" >> .env
  
  npm run dev

Сервер запустится на http://localhost:3001

═══════════════════════════════════════════════════════════════════════

4. ДЕПЛОЙ НА AWS EC2 (Free Tier)

Шаг 1: Создайте EC2 инстанс
   • AMI: Ubuntu 22.04 LTS
   • Instance type: t2.micro (Free Tier)
   • Security Group: открыть порты 22 (SSH), 3001 (WhatsApp Bridge)

Шаг 2: Подключитесь к серверу
   ssh -i your-key.pem ubuntu@your-ec2-ip

Шаг 3: Установите Docker
   sudo apt update
   sudo apt install -y docker.io docker-compose
   sudo usermod -aG docker ubuntu
   # Перелогиньтесь

Шаг 4: Загрузите код
   git clone https://github.com/your-repo/prosale.git
   cd prosale

Шаг 5: Настройте переменные окружения
   cp .env.example .env
   nano .env
   # Добавьте NEXT_PUBLIC_SUPABASE_URL и SUPABASE_SERVICE_ROLE_KEY

Шаг 6: Запустите WhatsApp Bridge
   docker-compose -f docker-compose.whatsapp.yml up -d

Шаг 7: Проверьте статус
   curl http://localhost:3001/health

═══════════════════════════════════════════════════════════════════════

4.1 ДЕПЛОЙ НА ORACLE CLOUD (Бесплатно навсегда)

Шаг 1: Зарегистрируйтесь на cloud.oracle.com

Шаг 2: Создайте VM Instance
   • Shape: VM.Standard.A1.Flex (ARM) — до 4 CPU, 24GB RAM бесплатно
   • Image: Ubuntu 22.04
   • Добавьте SSH ключ

Шаг 3: Настройте Security List
   • Добавьте Ingress Rule для порта 3001

Шаг 4: Далее как в AWS (шаги 2-7)

═══════════════════════════════════════════════════════════════════════

5. ПОДКЛЮЧЕНИЕ К PROSALE

После деплоя WhatsApp Bridge:

Шаг 1: Добавьте переменную в ProSale
   NEXT_PUBLIC_WA_BRIDGE_URL=http://your-server-ip:3001

Шаг 2: Перезапустите ProSale на Netlify

Шаг 3: Откройте ProSale → Настройки WhatsApp

Шаг 4: Нажмите "Добавить WhatsApp"

Шаг 5: Отсканируйте QR-код телефоном

Шаг 6: Готово! Чаты начнут появляться автоматически

═══════════════════════════════════════════════════════════════════════

6. ФУНКЦИОНАЛ

✅ Что работает:
   • Чтение входящих сообщений
   • Отправка текстовых сообщений
   • Подключение нескольких аккаунтов WhatsApp
   • AI подсказки на основе базы знаний
   • Теги для категоризации чатов
   • Быстрые ответы (шаблоны)
   • Распределение чатов между менеджерами
   • Заметки к чатам
   • Приоритеты и статусы чатов
   • Real-time обновления

⚠️ Ограничения:
   • Медиафайлы требуют дополнительной настройки storage
   • Группы частично поддерживаются
   • WhatsApp может заблокировать при спаме

═══════════════════════════════════════════════════════════════════════

7. УСТРАНЕНИЕ НЕПОЛАДОК

❌ "QR-код не появляется"
   → Проверьте, запущен ли WhatsApp Bridge
   → Проверьте подключение к Supabase
   → Смотрите логи: docker logs prosale-whatsapp-bridge

❌ "Сообщения не приходят"
   → Проверьте WebSocket соединение
   → Проверьте RLS политики в Supabase
   → Убедитесь, что сессия в статусе "connected"

❌ "AI подсказки не работают"
   → Проверьте OPENAI_API_KEY
   → Убедитесь, что база знаний проиндексирована

❌ "Сессия отключается"
   → WhatsApp требует активности на телефоне
   → Проверьте интернет-соединение на сервере

═══════════════════════════════════════════════════════════════════════

8. СТОИМОСТЬ (оценка)

┌────────────────────┬─────────────────┬──────────────────┐
│ Компонент          │ AWS Free Tier   │ Oracle Cloud     │
├────────────────────┼─────────────────┼──────────────────┤
│ VPS сервер         │ 12 мес бесплатно│ Навсегда бесплатно│
│ Supabase           │ Free tier       │ Free tier        │
│ OpenAI (подсказки) │ ~$5-20/мес      │ ~$5-20/мес       │
├────────────────────┼─────────────────┼──────────────────┤
│ ИТОГО              │ ~$5-20/мес      │ ~$5-20/мес       │
└────────────────────┴─────────────────┴──────────────────┘

═══════════════════════════════════════════════════════════════════════

📞 ПОДДЕРЖКА

Если возникли вопросы — создайте issue в репозитории
или напишите в Telegram.

═══════════════════════════════════════════════════════════════════════
